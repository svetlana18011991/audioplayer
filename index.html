<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Audio Player + Editor (Genially)</title>
  <style>
    :root{
      --bg: #0b0b0f;
      --panel: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.12);
      --text: #e9e9ef;
      --muted: rgba(233,233,239,.7);
      --accent: #a855f7;
      --accent2:#3b82f6;
      --radius: 16px;
    }
    html,body{
      height:100%; margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 0% 100%, rgba(168,85,247,.25), transparent 60%),
        radial-gradient(1200px 600px at 100% 0%, rgba(59,130,246,.18), transparent 60%),
        var(--bg);
    }
    body.playerOnly{ background: rgba(0,0,0,0); }
    body.playerOnly .app{ display:none; }

    /* ===== EDITOR ===== */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 18px;
      padding: 18px;
      box-sizing:border-box;
    }
    .left{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      overflow:auto;
    }
    h1{font-size:18px; margin:0 0 10px;}
    .desc{font-size:12px; color:var(--muted); margin-bottom: 14px; line-height:1.35;}
    .group{margin: 14px 0;}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    input[type="text"], input[type="url"], select, textarea{
      width:100%;
      box-sizing:border-box;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.28);
      color: var(--text);
      padding: 10px 10px;
      outline: none;
    }
    .row{display:flex; gap:10px; align-items:center;}
    .row > *{flex:1;}
    .btn{
      width:100%;
      border:0;
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      color:white;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      font-weight: 650;
      transition: .15s ease;
    }
    .btn:hover{ filter: brightness(1.05); }
    .btn.secondary{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      font-weight: 650;
    }
    .codeBox{ display:none; margin-top: 10px; }
    textarea{
      min-height: 140px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      line-height: 1.35;
    }
    .hint{font-size:12px; color:var(--muted); margin-top: 8px; line-height:1.35;}

    .right{
      position:relative;
      border-radius: var(--radius);
      border: 1px dashed rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      overflow:hidden;
      min-height: 520px;
    }
    .previewTitle{
      position:absolute;
      top: 10px; left: 12px;
      font-size: 12px;
      color: rgba(255,255,255,.75);
      letter-spacing:.2px;
      z-index: 2;
    }
    iframe{ width:100%; height:100%; border:0; background: transparent; }

    /* ===== PLAYER UI ===== */
    #playerRoot{ display:none; }
    body.playerOnly #playerRoot{ display:block; }

    .wrap{
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 12px;
      box-sizing:border-box;
    }

    .player{
      width: min(760px, 100%);
      background:
        radial-gradient(800px 280px at 0% 0%, rgba(168,85,247,.42), transparent 60%),
        radial-gradient(800px 280px at 100% 100%, rgba(59,130,246,.34), transparent 60%),
        rgba(20,20,24,.55);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      overflow:hidden;
      position: relative;
      backdrop-filter: blur(10px);
      color:#fff;
    }

    .top{display:flex; gap: 14px; padding: 16px 16px 10px; align-items:center;}
    .cover{
      width: 78px; height: 78px; border-radius: 999px; overflow:hidden; flex:0 0 auto;
      border: 2px solid rgba(255,255,255,.18); box-shadow: 0 10px 24px rgba(0,0,0,.25);
      background: rgba(255,255,255,.08);
    }
    .cover img{width:100%; height:100%; object-fit:cover; display:block;}
    .meta{min-width:0; flex:1 1 auto;}
    .title{font-size:22px; font-weight:750; line-height:1.15; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .sub{margin-top:4px; font-size:13px; color: rgba(255,255,255,.7); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}

    .icons{display:flex; gap:8px; align-items:center;}
    .iconBtn{
      width:38px; height:38px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
      cursor:pointer; display:grid; place-items:center; transition:.15s ease; user-select:none;
      color:#fff;
    }
    .iconBtn:hover{ background: rgba(255,255,255,.18); }
    .iconBtn.active{ border-color: rgba(255,255,255,.28); box-shadow: 0 0 0 3px rgba(168,85,247,.20); }

    .mid{padding: 0 16px 10px;}
    .timelineRow{display:flex; align-items:center; gap:10px; font-size:12px; color: rgba(255,255,255,.7);}
    .time{width:46px; text-align:center; font-variant-numeric: tabular-nums;}
    .bar{flex:1 1 auto; height:10px; border-radius:999px; background: rgba(255,255,255,.14); position:relative; cursor:pointer; overflow:hidden;}
    .barFill{position:absolute; inset:0; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius:999px;}
    .barKnob{position:absolute; top:50%; transform: translate(-50%,-50%); left:0%; width:14px; height:14px; border-radius:999px; background: rgba(255,255,255,.92); box-shadow: 0 10px 18px rgba(0,0,0,.25); pointer-events:none;}

    .controls{display:flex; align-items:center; justify-content:center; gap:10px; padding: 2px 16px 10px;}
    .btnP{
      width:48px; height:48px; border-radius:999px; border:0;
      background: rgba(255,255,255,.14);
      color:#fff; cursor:pointer; display:grid; place-items:center; transition:.15s ease;
    }
    .btnP:hover{ background: rgba(255,255,255,.22); }
    .btnP.big{ width:58px; height:58px; background: rgba(255,255,255,.18); border: 1px solid rgba(255,255,255,.16); }
    svg{ width:22px; height:22px; }

    .bottom{display:flex; align-items:center; gap:12px; padding: 0 16px 14px;}
    .vol{display:flex; align-items:center; gap:10px; flex:1 1 auto; min-width:0; color: rgba(255,255,255,.7); font-size:12px;}
    input[type="range"]{width:100%; accent-color: var(--accent); cursor:pointer;}

    .viz{height:62px; padding: 0 16px 16px;}
    canvas{width:100%; height:62px; display:block; background: rgba(0,0,0,.08); border: 1px solid rgba(255,255,255,.10); border-radius:14px;}

    .playlist{
      position:absolute; right:12px; top:92px; width: min(340px, calc(100% - 24px)); max-height:340px;
      background: rgba(16,16,18,.92);
      border:1px solid rgba(255,255,255,.16);
      border-radius:14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      overflow:hidden; display:none; backdrop-filter: blur(10px); z-index:5;
    }
    .playlist.open{ display:block; }
    .plistHead{ padding:10px 12px; font-size:12px; color: rgba(255,255,255,.7); display:flex; align-items:center; justify-content:space-between; border-bottom: 1px solid rgba(255,255,255,.10);}
    .plistItems{ max-height:300px; overflow:auto; }
    .track{ padding:10px 12px; cursor:pointer; display:flex; gap:10px; align-items:center; border-bottom: 1px solid rgba(255,255,255,.06); }
    .track:hover{ background: rgba(255,255,255,.06); }
    .track.active{ background: rgba(168,85,247,.18); }
    .tname{ flex:1 1 auto; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:13px;}
    .badge{ font-size:11px; color: rgba(255,255,255,.85); background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.10); padding:2px 8px; border-radius:999px; }
    .hintP{ padding: 8px 16px 16px; color: rgba(255,255,255,.75); font-size:12px; display:none; line-height:1.35; }
    .hintP.show{ display:block; }

    /* ===== RESUME OVERLAY ===== */
    .resumeOverlay{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      z-index: 20;
    }
    .resumeOverlay.show{ display:flex; }
    .resumeCard{
      background: rgba(20,20,24,.78);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 14px 14px;
      width: min(320px, calc(100% - 28px));
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      text-align:center;
    }
    .resumeTitle{ font-weight:750; margin-bottom:6px; }
    .resumeText{ font-size:12px; color: rgba(255,255,255,.75); line-height:1.35; margin-bottom:10px; }
    .resumeBtn{
      width:100%;
      border:0;
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      color:white;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      font-weight: 750;
    }

    /* ===== MINI MODE ===== */
    body.uiMini .wrap{ padding:0; min-height:auto; }
    body.uiMini .player{
      width: 100%;
      border-radius: 14px;
    }
    body.uiMini .top{ padding: 10px 10px 6px; gap:10px; }
    body.uiMini .cover{ width:42px; height:42px; }
    body.uiMini .title{ font-size:13px; }
    body.uiMini .sub{ font-size:11px; }
    body.uiMini .icons{ display:none; }          /* убираем like/playlist */
    body.uiMini .mid{ display:none; }            /* убираем таймлайн */
    body.uiMini .viz{ display:none; }            /* убираем визуализацию */
    body.uiMini .bottom{ padding: 0 10px 10px; }
    body.uiMini .controls{ padding: 4px 10px 4px; gap:8px; justify-content:flex-start;}
    body.uiMini .btnP{ width:40px; height:40px; }
    body.uiMini .btnP.big{ width:44px; height:44px; }
    body.uiMini .vol{ display:none; }            /* громкость убираем в мини */
  </style>
</head>
<body>

  <!-- EDITOR -->
  <div class="app">
    <div class="left">
      <h1>Редактор плеера</h1>
      <div class="desc">
        Настрой язык, обложку и режим UI (полный/мини). В Genially вставляй один и тот же iframe на каждой странице.
        <br><br>
        ⚠️ В большинстве браузеров автозапуск звука в новом iframe может блокироваться.
        Я добавила: попытку запустить через muted + кнопку “Продолжить музыку”, если браузер запретил.
      </div>

      <div class="group">
        <label>Язык интерфейса</label>
        <select id="lang">
          <option value="ru">Русский</option>
          <option value="en">English</option>
        </select>
      </div>

      <div class="group">
        <label>Ссылка на обложку (URL)</label>
        <input id="cover" type="url" placeholder="https://.../cover.jpg">
        <div class="hint">Пусто → дефолтная обложка.</div>
      </div>

      <div class="group">
        <label>Вид (UI)</label>
        <select id="ui">
          <option value="full">Полный</option>
          <option value="mini">Мини (фон)</option>
        </select>
        <div class="hint">Мини лучше для “фоновой музыки” (iframe можно сделать маленьким и поставить в угол).</div>
      </div>

      <div class="group row">
        <button class="btn secondary" id="btnPreview">Обновить предпросмотр</button>
        <button class="btn" id="btnCode">Получить iframe</button>
      </div>

      <div class="codeBox" id="codeBox">
        <label>Ссылка на плеер</label>
        <input id="playerLink" type="text" readonly>

        <div class="group">
          <label>iframe для Genially</label>
          <textarea id="codeArea" readonly></textarea>
          <div class="hint">
            Вставляй этот iframe одинаковым на всех страницах.
            <br>Если на новом слайде звук не стартует — нажми один раз “Продолжить музыку” (обычно после этого браузер начинает разрешать autoplay).
          </div>
        </div>

        <div class="group row">
          <button class="btn secondary" id="btnCopy">Скопировать</button>
          <button class="btn secondary" id="btnOpen">Открыть плеер</button>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="previewTitle">Предпросмотр</div>
      <iframe id="frame" allow="autoplay"></iframe>
    </div>
  </div>

  <!-- PLAYER -->
  <div id="playerRoot">
    <div class="wrap">
      <div class="player">
        <div class="resumeOverlay" id="resumeOverlay">
          <div class="resumeCard">
            <div class="resumeTitle" id="resumeTitle">Продолжить музыку</div>
            <div class="resumeText" id="resumeText">Браузер заблокировал автозапуск на новом слайде. Нажми кнопку — и дальше обычно будет играть автоматически.</div>
            <button class="resumeBtn" id="resumeBtn">Продолжить</button>
          </div>
        </div>

        <div class="top">
          <div class="cover"><img id="p_coverImg" alt=""></div>
          <div class="meta">
            <div class="title" id="p_trackTitle">Loading…</div>
            <div class="sub" id="p_trackSub">—</div>
          </div>
          <div class="icons">
            <button class="iconBtn" id="p_btnLike" title="Like">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0L12 5.6l-1-1a5.5 5.5 0 0 0-7.8 7.8l1 1L12 21l7.8-7.6 1-1a5.5 5.5 0 0 0 0-7.8z"></path>
              </svg>
            </button>
            <button class="iconBtn" id="p_btnPlaylist" title="Playlist">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 6h13"></path>
                <path d="M8 12h13"></path>
                <path d="M8 18h13"></path>
                <path d="M3 6h.01"></path>
                <path d="M3 12h.01"></path>
                <path d="M3 18h.01"></path>
              </svg>
            </button>
          </div>
        </div>

        <div class="mid">
          <div class="timelineRow">
            <div class="time" id="p_curTime">0:00</div>
            <div class="bar" id="p_seekBar">
              <div class="barFill" id="p_barFill"></div>
              <div class="barKnob" id="p_barKnob"></div>
            </div>
            <div class="time" id="p_durTime">0:00</div>
          </div>
        </div>

        <div class="controls">
          <button class="btnP" id="p_btnShuffle" title="Shuffle">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 3h5v5"></path>
              <path d="M4 20l6-6"></path>
              <path d="M16 3l-6 6"></path>
              <path d="M16 21h5v-5"></path>
              <path d="M4 4l6 6"></path>
              <path d="M21 16l-6-6"></path>
            </svg>
          </button>

          <button class="btnP" id="p_btnPrev" title="Prev">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M6 6h2v12H6zM20 6v12l-10-6z"></path>
            </svg>
          </button>

          <button class="btnP big" id="p_btnPlay" title="Play/Pause">
            <svg id="p_icoPlay" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z"></path>
            </svg>
          </button>

          <button class="btnP" id="p_btnNext" title="Next">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M16 6h2v12h-2zM4 18V6l10 6z"></path>
            </svg>
          </button>
        </div>

        <div class="bottom">
          <div class="vol">
            <span id="p_volLabel">Vol</span>
            <input type="range" id="p_volRange" min="0" max="1" step="0.01" value="0.8">
          </div>
        </div>

        <div class="viz">
          <canvas id="p_canvas" width="900" height="124"></canvas>
        </div>

        <div class="hintP" id="p_hint"></div>

        <div class="playlist" id="p_playlist">
          <div class="plistHead">
            <span id="p_plistTitle">Playlist</span>
            <span class="badge" id="p_plistCount">0</span>
          </div>
          <div class="plistItems" id="p_plistItems"></div>
        </div>

        <audio id="p_audio" crossorigin="anonymous"></audio>
      </div>
    </div>
  </div>

<script>
(() => {
  const qs = new URLSearchParams(location.search);
  const mode = (qs.get("mode") || "editor").toLowerCase();

  const DEFAULTS = {
    owner: "svetlana18011991",
    repo: "audioplayer",
    branch: "main",
    path: "",
    lang: "ru",
    cover: "",
    ui: "full",
    volume: 0.8,
    accent: "#a855f7",
    accent2: "#3b82f6",
  };

  const cfg = {
    owner: qs.get("owner") || DEFAULTS.owner,
    repo: qs.get("repo") || DEFAULTS.repo,
    branch: qs.get("branch") || DEFAULTS.branch,
    path: (qs.get("path") ?? DEFAULTS.path).replace(/^\/+|\/+$/g,""),
    lang: (qs.get("lang") || DEFAULTS.lang).toLowerCase(),
    cover: qs.get("cover") || DEFAULTS.cover,
    ui: (qs.get("ui") || DEFAULTS.ui).toLowerCase(),
    volume: clamp01(parseFloat(qs.get("volume") || DEFAULTS.volume)),
    accent: qs.get("accent") || DEFAULTS.accent,
    accent2: qs.get("accent2") || DEFAULTS.accent2,
  };

  // storage key: должен быть одинаковым на всех страницах
  const STORE_KEY = `genially_ap_state_v2:${cfg.owner}/${cfg.repo}/${cfg.branch}/${cfg.path}`;

  // ===== PLAYER MODE =====
  if (mode === "player") {
    document.body.classList.add("playerOnly");
    if (cfg.ui === "mini") document.body.classList.add("uiMini");

    document.documentElement.style.setProperty("--accent", cfg.accent);
    document.documentElement.style.setProperty("--accent2", cfg.accent2);

    runPlayer(cfg);
    return;
  }

  // ===== EDITOR MODE =====
  const langEl = document.getElementById("lang");
  const coverEl = document.getElementById("cover");
  const uiEl = document.getElementById("ui");
  const btnPreview = document.getElementById("btnPreview");
  const btnCode = document.getElementById("btnCode");
  const codeBox = document.getElementById("codeBox");
  const playerLink = document.getElementById("playerLink");
  const codeArea = document.getElementById("codeArea");
  const btnCopy = document.getElementById("btnCopy");
  const btnOpen = document.getElementById("btnOpen");
  const frame = document.getElementById("frame");

  langEl.value = cfg.lang;
  coverEl.value = cfg.cover;
  uiEl.value = cfg.ui;

  function buildPlayerUrl(){
    const base = location.href.split("?")[0];
    const p = new URLSearchParams();
    p.set("mode","player");
    p.set("lang", langEl.value);
    p.set("ui", uiEl.value);
    if (coverEl.value.trim()) p.set("cover", coverEl.value.trim());

    p.set("owner", cfg.owner);
    p.set("repo", cfg.repo);
    p.set("branch", cfg.branch);

    p.set("accent", cfg.accent);
    p.set("accent2", cfg.accent2);
    p.set("volume", String(cfg.volume));
    return base + "?" + p.toString();
  }

  function updatePreview(){ frame.src = buildPlayerUrl(); }

  btnPreview.addEventListener("click", updatePreview);

  btnCode.addEventListener("click", () => {
    const url = buildPlayerUrl();
    playerLink.value = url;

    // Для mini — рекомендуем маленький размер и позиционирование в угол
    const isMini = (uiEl.value === "mini");
    const w = isMini ? 320 : 760;
    const h = isMini ? 110 : 420;

    const iframeCode =
`<iframe
  src="${url}"
  width="${w}"
  height="${h}"
  style="border:0;background:transparent;${isMini ? "position:fixed;right:12px;bottom:12px;z-index:9999;" : ""}"
  allow="autoplay"
  loading="lazy"
></iframe>`;
    codeArea.value = iframeCode;
    codeBox.style.display = "block";
  });

  btnCopy.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(codeArea.value);
      btnCopy.textContent = "Скопировано!";
      setTimeout(()=>btnCopy.textContent="Скопировать", 900);
    }catch{
      btnCopy.textContent = "Не удалось";
      setTimeout(()=>btnCopy.textContent="Скопировать", 900);
    }
  });

  btnOpen.addEventListener("click", () => window.open(buildPlayerUrl(), "_blank"));

  updatePreview();

  // ===== PLAYER LOGIC =====
  function runPlayer(config){
    const i18n = {
      ru: {
        loading:"Загрузка…",
        playlist:"Плейлист",
        vol:"Громкость",
        noTracks:"Не нашёл аудиофайлы в корне репозитория. Проверь public и форматы mp3/wav/ogg/m4a/aac/flac.",
        apiLimit:"GitHub API ограничил запросы. Подождите и попробуйте снова.",
        resumeTitle:"Продолжить музыку",
        resumeText:"Браузер заблокировал автозапуск на новом слайде. Нажми кнопку — обычно дальше будет играть автоматически.",
        resumeBtn:"Продолжить"
      },
      en: {
        loading:"Loading…",
        playlist:"Playlist",
        vol:"Volume",
        noTracks:"No audio files found in repo root. Check repo is public and audio formats.",
        apiLimit:"GitHub API rate limit hit. Wait and try again.",
        resumeTitle:"Resume audio",
        resumeText:"Autoplay was blocked on the new slide. Tap the button to resume.",
        resumeBtn:"Resume"
      }
    };
    const t = i18n[config.lang] || i18n.ru;

    const audio = document.getElementById("p_audio");
    const coverImg = document.getElementById("p_coverImg");
    const trackTitle = document.getElementById("p_trackTitle");
    const trackSub = document.getElementById("p_trackSub");
    const curTime = document.getElementById("p_curTime");
    const durTime = document.getElementById("p_durTime");
    const seekBar = document.getElementById("p_seekBar");
    const barFill = document.getElementById("p_barFill");
    const barKnob = document.getElementById("p_barKnob");

    const btnPlay = document.getElementById("p_btnPlay");
    const icoPlay = document.getElementById("p_icoPlay");
    const btnPrev = document.getElementById("p_btnPrev");
    const btnNext = document.getElementById("p_btnNext");
    const btnShuffle = document.getElementById("p_btnShuffle");
    const btnPlaylist = document.getElementById("p_btnPlaylist");
    const btnLike = document.getElementById("p_btnLike");

    const playlistEl = document.getElementById("p_playlist");
    const plistTitle = document.getElementById("p_plistTitle");
    const plistCount = document.getElementById("p_plistCount");
    const plistItems = document.getElementById("p_plistItems");

    const volLabel = document.getElementById("p_volLabel");
    const volRange = document.getElementById("p_volRange");
    const hint = document.getElementById("p_hint");

    const resumeOverlay = document.getElementById("resumeOverlay");
    const resumeTitle = document.getElementById("resumeTitle");
    const resumeText  = document.getElementById("resumeText");
    const resumeBtn   = document.getElementById("resumeBtn");

    resumeTitle.textContent = t.resumeTitle;
    resumeText.textContent  = t.resumeText;
    resumeBtn.textContent   = t.resumeBtn;

    trackTitle.textContent = t.loading;
    plistTitle.textContent = t.playlist;
    volLabel.textContent = t.vol;
    trackSub.textContent = `${config.owner}/${config.repo}${config.path?"/"+config.path:""}`;
    coverImg.src = config.cover || svgPlaceholder(config.accent, config.accent2);

    function loadState(){
      try{ return JSON.parse(localStorage.getItem(STORE_KEY)); }
      catch{ return null; }
    }
    function saveState(extra = {}){
      const state = {
        trackIndex: currentIndex,
        time: audio.currentTime || 0,
        volume: audio.volume,
        isPlaying: !audio.paused,
        shuffle: isShuffle,
        order: shuffleOrder,
        ts: Date.now(),
        ...extra
      };
      localStorage.setItem(STORE_KEY, JSON.stringify(state));
    }

    const saved = loadState();

    let tracks = [];
    let currentIndex = clampInt(saved?.trackIndex ?? 0, 0, 999999);
    let isShuffle = !!(saved?.shuffle ?? false);
    let shuffleOrder = Array.isArray(saved?.order) ? saved.order : [];

    audio.volume = clamp01(saved?.volume ?? config.volume);
    volRange.value = String(audio.volume);

    volRange.addEventListener("input", () => {
      audio.volume = clamp01(parseFloat(volRange.value));
      saveState();
    });

    btnPlay.addEventListener("click", () => {
      if(audio.paused) audio.play().catch(()=>{});
      else audio.pause();
    });

    btnPrev.addEventListener("click", prev);
    btnNext.addEventListener("click", next);

    btnShuffle.addEventListener("click", () => {
      isShuffle = !isShuffle;
      btnShuffle.classList.toggle("active", isShuffle);

      if(isShuffle){
        shuffleOrder = [...Array(tracks.length).keys()];
        for(let i=shuffleOrder.length-1;i>0;i--){
          const j = Math.floor(Math.random()*(i+1));
          [shuffleOrder[i], shuffleOrder[j]] = [shuffleOrder[j], shuffleOrder[i]];
        }
      }else{
        shuffleOrder = [];
      }
      saveState();
    });

    if (btnPlaylist) btnPlaylist.addEventListener("click", () => playlistEl.classList.toggle("open"));
    if (btnLike) btnLike.addEventListener("click", () => btnLike.classList.toggle("active"));

    document.addEventListener("click", (e) => {
      if (!playlistEl || !btnPlaylist) return;
      const inside = playlistEl.contains(e.target) || btnPlaylist.contains(e.target);
      if(!inside) playlistEl.classList.remove("open");
    });

    audio.addEventListener("play", () => {
      icoPlay.innerHTML = `<path d="M6 5h4v14H6zM14 5h4v14h-4z"></path>`;
      saveState({ isPlaying:true });
    });

    audio.addEventListener("pause", () => {
      icoPlay.innerHTML = `<path d="M8 5v14l11-7z"></path>`;
      saveState({ isPlaying:false });
    });

    audio.addEventListener("timeupdate", () => {
      updateProgress();
      if(Math.floor(audio.currentTime) % 2 === 0) saveState();
    });

    audio.addEventListener("loadedmetadata", updateProgress);
    audio.addEventListener("ended", () => next());

    let seeking = false;
    seekBar.addEventListener("pointerdown", (e) => { seeking = true; seekToEvent(e); seekBar.setPointerCapture(e.pointerId); });
    seekBar.addEventListener("pointermove", (e) => { if(seeking) seekToEvent(e); });
    seekBar.addEventListener("pointerup", () => { seeking = false; saveState(); });

    function seekToEvent(e){
      if(!audio.duration || !isFinite(audio.duration)) return;
      const rect = seekBar.getBoundingClientRect();
      const x = Math.min(Math.max(0, e.clientX - rect.left), rect.width);
      audio.currentTime = (x / rect.width) * audio.duration;
      updateProgress();
    }

    function renderPlaylist(){
      if(!plistItems) return;
      plistItems.innerHTML = "";
      tracks.forEach((tr, i) => {
        const row = document.createElement("div");
        row.className = "track";
        row.dataset.i = String(i);

        const name = document.createElement("div");
        name.className = "tname";
        name.textContent = prettifyName(tr.name);

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = String(i+1);

        row.appendChild(name);
        row.appendChild(badge);

        row.addEventListener("click", () => {
          loadIndex(i);
          tryPlayWithFallback(true);
        });

        plistItems.appendChild(row);
      });
      markActive();
    }

    function markActive(){
      if(!plistItems) return;
      [...plistItems.querySelectorAll(".track")].forEach(el => {
        el.classList.toggle("active", parseInt(el.dataset.i,10) === currentIndex);
      });
    }

    function loadIndex(i){
      currentIndex = clampInt(i, 0, tracks.length-1);
      const tr = tracks[currentIndex];
      audio.src = tr.url;

      trackTitle.textContent = prettifyName(tr.name);
      trackSub.textContent = `${config.owner}/${config.repo}${config.path?"/"+config.path:""}`;

      markActive();
      updateProgress();
      saveState();
    }

    function next(){
      if(!tracks.length) return;
      if(isShuffle && shuffleOrder.length){
        const pos = shuffleOrder.indexOf(currentIndex);
        const nextIdx = shuffleOrder[(pos+1) % shuffleOrder.length];
        loadIndex(nextIdx);
      }else{
        loadIndex((currentIndex+1) % tracks.length);
      }
      tryPlayWithFallback(true);
    }

    function prev(){
      if(!tracks.length) return;
      if(isShuffle && shuffleOrder.length){
        const pos = shuffleOrder.indexOf(currentIndex);
        const prevIdx = shuffleOrder[(pos-1+shuffleOrder.length) % shuffleOrder.length];
        loadIndex(prevIdx);
      }else{
        loadIndex((currentIndex-1+tracks.length) % tracks.length);
      }
      tryPlayWithFallback(true);
    }

    function updateProgress(){
      const ct = audio.currentTime || 0;
      const dur = audio.duration || 0;
      curTime.textContent = fmtTime(ct);
      durTime.textContent = fmtTime(dur);
      const p = dur ? (ct/dur) : 0;
      barFill.style.width = (p*100).toFixed(2) + "%";
      barKnob.style.left = (p*100).toFixed(2) + "%";
    }

    function showHint(text, show){
      hint.textContent = text;
      hint.classList.toggle("show", !!show);
    }

    // ---- autoplay best-effort ----
    async function tryPlayWithFallback(userInitiated){
      // 1) обычная попытка
      try{
        await audio.play();
        resumeOverlay.classList.remove("show");
        return true;
      }catch(e1){
        // 2) попытка через muted autoplay (часто разрешают)
        try{
          const prevMuted = audio.muted;
          audio.muted = true;
          await audio.play();
          // попробуем размьютить (иногда разрешают сразу после старта)
          setTimeout(() => {
            audio.muted = prevMuted;
          }, 250);
          resumeOverlay.classList.remove("show");
          return true;
        }catch(e2){
          // 3) показать кнопку (нужен клик)
          if(!userInitiated){
            resumeOverlay.classList.add("show");
          }
          return false;
        }
      }
    }

    resumeBtn.addEventListener("click", async () => {
      resumeOverlay.classList.remove("show");
      // клик — это жест пользователя, тут play обычно проходит
      try{
        audio.muted = false;
        await audio.play();
      }catch{
        // если вдруг не получилось — вернём оверлей
        resumeOverlay.classList.add("show");
      }
    });

    // ---- visualization (можно отключить в mini) ----
    const canvas = document.getElementById("p_canvas");
    const ctx = canvas.getContext("2d");
    let audioCtx, analyser, srcNode, freqData;

    function getAudioCtx(){
      if(audioCtx) return audioCtx;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }
    function initAnalyser(){
      if(analyser) return;
      const ac = getAudioCtx();
      analyser = ac.createAnalyser();
      analyser.fftSize = 256;
      freqData = new Uint8Array(analyser.frequencyBinCount);

      srcNode = ac.createMediaElementSource(audio);
      srcNode.connect(analyser);
      analyser.connect(ac.destination);

      requestAnimationFrame(drawViz);
    }
    audio.addEventListener("play", () => {
      // в mini может быть скрыт canvas — но это не мешает
      initAnalyser();
      const ac = getAudioCtx();
      if(ac.state === "suspended") ac.resume().catch(()=>{});
    });

    function drawViz(){
      requestAnimationFrame(drawViz);
      if(!analyser) return;

      analyser.getByteFrequencyData(freqData);

      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0,0,w,h);

      ctx.fillStyle = "rgba(255,255,255,0.04)";
      ctx.fillRect(0,0,w,h);

      const bars = 58;
      const step = Math.floor(freqData.length / bars);
      const gap = 6;
      const bw = (w - (bars+1)*gap) / bars;

      const grad = ctx.createLinearGradient(0,0,w,0);
      grad.addColorStop(0, config.accent);
      grad.addColorStop(1, config.accent2);
      ctx.fillStyle = grad;

      for(let i=0;i<bars;i++){
        const v = freqData[i*step] / 255;
        const bh = Math.max(4, v * (h-14));
        const x = gap + i*(bw+gap);
        const y = h - bh - 7;
        roundRect(ctx, x, y, bw, bh, 10);
        ctx.fill();
      }
    }
    function roundRect(c, x, y, w, h, r){
      c.beginPath();
      c.moveTo(x+r, y);
      c.arcTo(x+w, y, x+w, y+h, r);
      c.arcTo(x+w, y+h, x, y+h, r);
      c.arcTo(x, y+h, x, y, r);
      c.arcTo(x, y, x+w, y, r);
      c.closePath();
    }

    // ---- Load tracks from GitHub root ----
    async function loadTracks(){
      const base = `https://api.github.com/repos/${encodeURIComponent(config.owner)}/${encodeURIComponent(config.repo)}/contents`;
      const api = config.path
        ? `${base}/${encodeURIComponent(config.path)}?ref=${encodeURIComponent(config.branch)}`
        : `${base}?ref=${encodeURIComponent(config.branch)}`;

      try{
        const res = await fetch(api, {headers: {"Accept":"application/vnd.github+json"}});
        if(res.status === 403){ showHint(t.apiLimit, true); return; }
        if(!res.ok){ showHint(t.noTracks, true); return; }

        const data = await res.json();
        const items = Array.isArray(data) ? data : [data];

        const exts = [".mp3",".wav",".ogg",".m4a",".aac",".flac"];
        tracks = items
          .filter(x => x && x.type === "file" && typeof x.name === "string")
          .filter(x => exts.some(e => x.name.toLowerCase().endsWith(e)))
          .map(x => ({ name: x.name, url: x.download_url }));

        if(plistCount) plistCount.textContent = String(tracks.length);
        if(!tracks.length){ showHint(t.noTracks, true); return; }

        btnShuffle.classList.toggle("active", isShuffle);

        if(isShuffle && shuffleOrder.length !== tracks.length){
          shuffleOrder = [...Array(tracks.length).keys()];
          for(let i=shuffleOrder.length-1;i>0;i--){
            const j = Math.floor(Math.random()*(i+1));
            [shuffleOrder[i], shuffleOrder[j]] = [shuffleOrder[j], shuffleOrder[i]];
          }
        }

        renderPlaylist();

        currentIndex = clampInt(currentIndex, 0, tracks.length-1);
        loadIndex(currentIndex);

        // ==== restore time + try continue ====
        const saved2 = loadState();
        const restoreTime = saved2?.time ?? 0;
        const restoreWasPlaying = !!saved2?.isPlaying;

        audio.addEventListener("loadedmetadata", async () => {
          if(restoreTime > 0 && isFinite(audio.duration) && restoreTime < audio.duration){
            audio.currentTime = restoreTime;
            updateProgress();
          }
          if(restoreWasPlaying){
            // попытка продолжить автоматически
            await tryPlayWithFallback(false);
          }
        }, { once:true });

      }catch{
        showHint(t.noTracks, true);
      }
    }

    loadTracks();
  }

  // helpers
  function fmtTime(s){
    if(!isFinite(s)) return "0:00";
    const m = Math.floor(s/60);
    const sec = Math.floor(s%60);
    return `${m}:${String(sec).padStart(2,"0")}`;
  }
  function prettifyName(name){
    return decodeURIComponent(name)
      .replace(/\.[^.]+$/,"")
      .replace(/[_]+/g," ")
      .replace(/[-]+/g," ")
      .trim();
  }
  function clamp01(x){ return isFinite(x) ? Math.min(1, Math.max(0, x)) : 0.8; }
  function clampInt(x, a, b){ x = (x|0); return Math.min(b, Math.max(a, x)); }
  function svgPlaceholder(c1, c2){
    const svg =
      `<svg xmlns="http://www.w3.org/2000/svg" width="240" height="240">
        <defs>
          <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0" stop-color="${c1}"/>
            <stop offset="1" stop-color="${c2}"/>
          </linearGradient>
        </defs>
        <rect width="240" height="240" rx="120" fill="url(#g)"/>
        <circle cx="120" cy="115" r="52" fill="rgba(255,255,255,0.18)"/>
        <path d="M108 92v52l44-26z" fill="rgba(255,255,255,0.82)"/>
      </svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }
})();
</script>
</body>
</html>
