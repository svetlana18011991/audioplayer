<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Audio Player Widget Editor (for Genially)</title>
  <style>
    :root{
      --bg:#0000;
      --panel:#12121acc;
      --text:#f5f5ff;
      --muted:#b9b9d3;
      --line:#ffffff1f;
      --accent:#b33bff;
      --accent2:#7a2bff;
      --chip:#ffffff14;
      --shadow: 0 18px 55px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(900px 500px at 20% 10%, rgba(179,59,255,.25), transparent 60%),
                  radial-gradient(900px 500px at 80% 90%, rgba(122,43,255,.18), transparent 60%),
                  #0b0b12;
      color:var(--text);
    }

    .wrap{
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px 28px;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card h2{
      margin:0;
      padding:14px 16px;
      font-size:14px;
      letter-spacing:.3px;
      text-transform:uppercase;
      border-bottom:1px solid var(--line);
      color: #eaeaff;
    }

    .card .content{ padding: 14px 16px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin: 0 0 6px;
    }
    input[type="text"], input[type="url"], select, textarea{
      width:100%;
      box-sizing:border-box;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0f0f18;
      color:var(--text);
      outline:none;
    }
    textarea{ min-height: 84px; resize: vertical; font-family: var(--mono); font-size:12px; }
    input[type="color"]{
      width:100%;
      height:40px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0f0f18;
      padding:4px;
      box-sizing:border-box;
    }
    .row{ display:flex; gap:10px; align-items:center; }
    .row > *{ flex:1; }
    .hint{
      font-size:12px;
      color: var(--muted);
      line-height: 1.35;
      margin-top: 8px;
      opacity:.95;
    }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    button{
      cursor:pointer;
      border:none;
      border-radius:14px;
      padding:10px 12px;
      font-weight:700;
      color:#fff;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 28px rgba(179,59,255,.24);
    }
    button.secondary{
      background: #ffffff12;
      box-shadow:none;
      border:1px solid var(--line);
      color: var(--text);
      font-weight:600;
    }
    button:active{ transform: translateY(1px); }

    .previewStage{
      padding: 16px;
      display:flex;
      justify-content:center;
      align-items:center;
      min-height: 360px;
      background:
        linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px) 0 0 / 16px 16px,
        linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px) 0 0 / 16px 16px,
        transparent;
    }

    .codeBox{
      display:none;
      padding: 0;
    }
    .codeTop{
      display:flex; gap:10px; align-items:center;
      padding: 12px 16px;
      border-bottom:1px solid var(--line);
    }
    .codeTop strong{ font-size:13px; }
    .codeTop .grow{ flex:1; }
    .codeArea{
      width:100%;
      min-height: 320px;
      border:0;
      outline:none;
      padding: 14px 16px;
      background:#0b0b12;
      color:#eaeaff;
      font-family:var(--mono);
      font-size:12px;
      line-height:1.45;
      box-sizing:border-box;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: var(--chip);
      border: 1px solid var(--line);
      font-size:12px;
      color: var(--muted);
      margin-top: 10px;
    }
    .pill b{ color: var(--text); font-weight:700; }

    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Настройки</h2>
      <div class="content">
        <div class="grid">
          <div>
            <label>Язык интерфейса</label>
            <select id="lang">
              <option value="ru" selected>Русский</option>
              <option value="en">English</option>
            </select>
          </div>
          <div>
            <label>Показывать ползунок громкости</label>
            <select id="showVolume">
              <option value="1" selected>Да</option>
              <option value="0">Нет</option>
            </select>
          </div>

          <div>
            <label>Акцент (кнопки/ползунки)</label>
            <input id="accent" type="color" value="#b33bff">
          </div>
          <div>
            <label>Второй цвет градиента</label>
            <input id="accent2" type="color" value="#7a2bff">
          </div>

          <div>
            <label>Цвет текста</label>
            <input id="textColor" type="color" value="#ffffff">
          </div>
          <div>
            <label>Цвет “вторичного” текста</label>
            <input id="mutedColor" type="color" value="#c7c7e6">
          </div>

          <div>
            <label>Радиус скругления (px)</label>
            <input id="radius" type="text" value="22">
          </div>
          <div>
            <label>Высота виджета (px)</label>
            <input id="height" type="text" value="220">
          </div>
        </div>

        <div style="height:12px"></div>

        <div>
          <label>Ссылка на папку в GitHub (tree/…/path)</label>
          <input id="githubFolder" type="url" value="https://github.com/svetlana18011991/audioplayer/tree/main/audio">
          <div class="hint">
            Плеер сам подгрузит список аудиофайлов из папки через GitHub API и будет играть по ссылкам <b>download_url</b>.
            Поддержка: mp3, ogg, wav, m4a.
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="row">
          <div>
            <label>Картинка (URL) — круглый арт</label>
            <input id="coverUrl" type="url" value="https://images.unsplash.com/photo-1520975958225-2d2f8a6f0bd0?auto=format&fit=crop&w=600&q=60">
          </div>
          <div>
            <label>…или загрузить файл</label>
            <input id="coverFile" type="file" accept="image/*">
          </div>
        </div>

        <div class="pill">
          Плеер для Genially будет с <b>прозрачным фоном</b>, как ты просила.
        </div>

        <div class="btns">
          <button id="apply">Обновить предпросмотр</button>
          <button id="getCode" class="secondary">Получить код для Genially</button>
          <button id="copyCode" class="secondary" style="display:none">Копировать код</button>
        </div>

        <div class="hint" style="margin-top:12px">
          В Genially обычно вставляют код в “Insert → Other → Embed / iFrame”.
          Если Genially ругается на inline-script, используй “вставку через iframe” (ниже в коде уже всё готово).
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Предпросмотр</h2>
      <div class="previewStage">
        <div id="previewHost"></div>
      </div>

      <div class="codeBox" id="codeBox">
        <div class="codeTop">
          <strong>Код для вставки в Genially</strong>
          <div class="grow"></div>
          <button id="closeCode" class="secondary">Закрыть</button>
        </div>
        <textarea class="codeArea" id="codeArea" spellcheck="false"></textarea>
      </div>
    </div>
  </div>

<script>
/**
 * Редактор генерирует "player-only" код (без UI редактора).
 * Внутри: web-component <am-audioplayer> + конфиг JSON.
 * Без внешних библиотек.
 */

const els = {
  lang:        document.getElementById('lang'),
  showVolume:  document.getElementById('showVolume'),
  accent:      document.getElementById('accent'),
  accent2:     document.getElementById('accent2'),
  textColor:   document.getElementById('textColor'),
  mutedColor:  document.getElementById('mutedColor'),
  radius:      document.getElementById('radius'),
  height:      document.getElementById('height'),
  githubFolder:document.getElementById('githubFolder'),
  coverUrl:    document.getElementById('coverUrl'),
  coverFile:   document.getElementById('coverFile'),

  apply:       document.getElementById('apply'),
  getCode:     document.getElementById('getCode'),
  copyCode:    document.getElementById('copyCode'),

  previewHost: document.getElementById('previewHost'),
  codeBox:     document.getElementById('codeBox'),
  codeArea:    document.getElementById('codeArea'),
  closeCode:   document.getElementById('closeCode'),
};

let coverDataUrl = null;

els.coverFile.addEventListener('change', async () => {
  const file = els.coverFile.files?.[0];
  if (!file) return;
  coverDataUrl = await fileToDataURL(file);
  els.coverUrl.value = '';
  renderPreview();
});

els.apply.addEventListener('click', renderPreview);

els.getCode.addEventListener('click', () => {
  const cfg = getConfig();
  const code = buildGeniallyEmbedCode(cfg);
  els.codeArea.value = code;
  els.codeBox.style.display = 'block';
  els.copyCode.style.display = 'inline-flex';
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
});

els.closeCode.addEventListener('click', () => {
  els.codeBox.style.display = 'none';
  els.copyCode.style.display = 'none';
});

els.copyCode.addEventListener('click', async () => {
  try{
    await navigator.clipboard.writeText(els.codeArea.value);
    els.copyCode.textContent = 'Скопировано ✓';
    setTimeout(()=> els.copyCode.textContent = 'Копировать код', 1200);
  }catch(e){
    alert('Не удалось скопировать автоматически. Скопируй вручную из окна кода.');
  }
});

function getConfig(){
  return {
    lang: els.lang.value,
    showVolume: els.showVolume.value === '1',
    theme: {
      accent: els.accent.value,
      accent2: els.accent2.value,
      text: els.textColor.value,
      muted: els.mutedColor.value,
      radius: clampInt(els.radius.value, 0, 60, 22),
    },
    layout: {
      height: clampInt(els.height.value, 140, 420, 220)
    },
    githubFolderUrl: els.githubFolder.value.trim(),
    cover: (coverDataUrl || els.coverUrl.value.trim() || null),
  };
}

function renderPreview(){
  const cfg = getConfig();
  els.previewHost.innerHTML = `
    <am-audioplayer style="width:min(720px, 100%); height:${cfg.layout.height}px;"></am-audioplayer>
  `;
  ensurePlayerDefined();
  const el = els.previewHost.querySelector('am-audioplayer');
  el.setConfig(cfg);
}

function clampInt(v, min, max, fallback){
  const n = parseInt(String(v||'').trim(), 10);
  if (Number.isNaN(n)) return fallback;
  return Math.max(min, Math.min(max, n));
}

function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/** --- Генерация кода для Genially --- */
function buildGeniallyEmbedCode(cfg){
  // Вариант 1: "прямой" код (если Genially принимает inline script)
  // Вариант 2: iframe-srcdoc (почти всегда проходит)
  // Мы отдаём iframe-srcdoc как самый надёжный.
  const playerOnlyHtml = buildPlayerOnlyHtml(cfg)
    .replaceAll(/<\/script>/g, '<\\/script>'); // защита для srcdoc

  const h = cfg.layout.height;

  return `<!-- Atomicmail AudioPlayer (transparent) -->
<iframe
  style="width:100%; height:${h}px; border:0; background:transparent;"
  sandbox="allow-scripts allow-same-origin allow-downloads"
  srcdoc="${escapeHtmlAttr(playerOnlyHtml)}">
</iframe>`;
}

function escapeHtmlAttr(s){
  return s
    .replaceAll('&','&amp;')
    .replaceAll('"','&quot;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;');
}

/** --- "Player-only" HTML (без редактора) --- */
function buildPlayerOnlyHtml(cfg){
  const configJson = JSON.stringify(cfg);

  return `<!doctype html>
<html lang="${cfg.lang}">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  html,body{height:100%; margin:0; background:transparent;}
  body{display:flex; align-items:center; justify-content:center;}
</style>
</head>
<body>
  <am-audioplayer style="width:100%; height:${cfg.layout.height}px;"></am-audioplayer>

  <script>
    (${playerComponentSource()})();
    const el = document.querySelector('am-audioplayer');
    el.setConfig(${configJson});
  </script>
</body>
</html>`;
}

/** --- Исходник Web Component (возвращаем как строку) --- */
function playerComponentSource(){
  // Важно: без внешних библиотек.
  return function(){
    const I18N = {
      ru: {
        playlist: "Плейлист",
        loading: "Загрузка…",
        empty: "Файлы не найдены в папке",
        shuffle: "Случайно",
        prev: "Назад",
        next: "Вперёд",
        play: "Играть",
        pause: "Пауза",
        volume: "Громкость",
        error: "Не удалось загрузить список. Проверь ссылку на GitHub папку.",
      },
      en: {
        playlist: "Playlist",
        loading: "Loading…",
        empty: "No audio files found",
        shuffle: "Shuffle",
        prev: "Prev",
        next: "Next",
        play: "Play",
        pause: "Pause",
        volume: "Volume",
        error: "Failed to load list. Check the GitHub folder link.",
      }
    };

    const AUDIO_EXT = /\.(mp3|ogg|wav|m4a)$/i;

    class AMAudioPlayer extends HTMLElement{
      constructor(){
        super();
        this.attachShadow({mode:'open'});
        this._cfg = null;

        this.state = {
          tracks: [],
          idx: 0,
          playing: false,
          shuffle: false,
          order: [],
          showList: false,
          loading: false,
          error: "",
        };

        this.audio = new Audio();
        this.audio.preload = "metadata";
        this.audio.crossOrigin = "anonymous";

        this._onTime = () => this._renderProgress();
        this._onEnded = () => this.next(true);
      }

      connectedCallback(){
        this._renderShell();
        this._wire();
        this.audio.addEventListener('timeupdate', this._onTime);
        this.audio.addEventListener('ended', this._onEnded);
      }

      disconnectedCallback(){
        this.audio.removeEventListener('timeupdate', this._onTime);
        this.audio.removeEventListener('ended', this._onEnded);
      }

      setConfig(cfg){
        this._cfg = cfg;
        this._applyTheme();
        this._setCover(cfg.cover);
        this._loadFromGithub(cfg.githubFolderUrl);
        this._renderText();
      }

      _t(key){
        const lang = (this._cfg?.lang || 'ru');
        return (I18N[lang] && I18N[lang][key]) || I18N.ru[key] || key;
      }

      _applyTheme(){
        const t = this._cfg?.theme || {};
        const r = (t.radius ?? 22);
        const root = this.shadowRoot.host;
        root.style.setProperty('--ap-accent', t.accent || '#b33bff');
        root.style.setProperty('--ap-accent2', t.accent2 || '#7a2bff');
        root.style.setProperty('--ap-text', t.text || '#fff');
        root.style.setProperty('--ap-muted', t.muted || '#c7c7e6');
        root.style.setProperty('--ap-radius', r + 'px');
      }

      _renderShell(){
        this.shadowRoot.innerHTML = `
<style>
  :host{
    display:block;
    background:transparent;
    --ap-accent:#b33bff;
    --ap-accent2:#7a2bff;
    --ap-text:#fff;
    --ap-muted:#c7c7e6;
    --ap-radius:22px;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }

  .wrap{
    position:relative;
    height:100%;
    border-radius: var(--ap-radius);
    overflow:hidden;
    color: var(--ap-text);
    box-shadow: 0 18px 55px rgba(0,0,0,.35);
    border: 1px solid rgba(255,255,255,.14);
    background:
      radial-gradient(900px 500px at 10% 10%, color-mix(in oklab, var(--ap-accent) 55%, transparent), transparent 60%),
      radial-gradient(900px 500px at 90% 90%, color-mix(in oklab, var(--ap-accent2) 50%, transparent), transparent 60%),
      linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    backdrop-filter: blur(10px);
  }

  .inner{
    height:100%;
    display:grid;
    grid-template-columns: 190px 1fr;
    gap: 14px;
    padding: 14px;
    box-sizing:border-box;
  }

  .left{
    display:flex;
    flex-direction:column;
    gap: 10px;
    justify-content:center;
    align-items:flex-start;
    position:relative;
    min-width: 170px;
  }

  .cover{
    width: 132px;
    height: 132px;
    border-radius: 999px;
    overflow:hidden;
    border: 3px solid rgba(255,255,255,.22);
    box-shadow: 0 14px 35px rgba(0,0,0,.35);
    background: rgba(0,0,0,.15);
  }
  .cover img{ width:100%; height:100%; object-fit:cover; display:block; }

  .viz{
    position:absolute;
    left: 0;
    bottom: 6px;
    width: 170px;
    height: 74px;
    display:flex;
    align-items:flex-end;
    gap: 6px;
    opacity:.85;
    pointer-events:none;
  }
  .bar{
    width: 10px;
    border-radius: 6px;
    background: rgba(255,255,255,.18);
    transform-origin: bottom;
    height: 18px;
  }
  .playing .bar{
    background: rgba(255,255,255,.22);
    animation: bounce 900ms infinite ease-in-out;
  }
  .bar:nth-child(2){ animation-delay: -120ms; }
  .bar:nth-child(3){ animation-delay: -260ms; }
  .bar:nth-child(4){ animation-delay: -340ms; }
  .bar:nth-child(5){ animation-delay: -180ms; }
  .bar:nth-child(6){ animation-delay: -420ms; }
  .bar:nth-child(7){ animation-delay: -520ms; }
  @keyframes bounce{
    0%,100%{ transform: scaleY(.35); }
    50%{ transform: scaleY(1.05); }
  }

  .right{
    display:flex;
    flex-direction:column;
    justify-content:center;
    gap: 10px;
    min-width: 0;
  }

  .topRow{
    display:flex;
    align-items:flex-start;
    gap: 10px;
  }
  .meta{
    flex:1;
    min-width:0;
  }
  .title{
    font-size: 22px;
    font-weight: 800;
    line-height: 1.1;
    margin: 0;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .subtitle{
    margin-top: 4px;
    font-size: 13px;
    color: var(--ap-muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .icons{
    display:flex;
    gap: 8px;
    align-items:center;
  }
  .iconBtn{
    width: 36px; height: 36px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.10);
    display:grid; place-items:center;
    cursor:pointer;
    user-select:none;
  }
  .iconBtn:hover{ background: rgba(255,255,255,.14); }
  .iconBtn.active{
    border-color: color-mix(in oklab, var(--ap-accent) 60%, rgba(255,255,255,.18));
    box-shadow: 0 10px 26px rgba(179,59,255,.22);
  }

  .progressRow{
    display:grid;
    grid-template-columns: 46px 1fr 46px;
    gap: 10px;
    align-items:center;
    font-size: 12px;
    color: var(--ap-muted);
  }
  .time{
    font-variant-numeric: tabular-nums;
  }
  input[type="range"]{
    width:100%;
    accent-color: var(--ap-accent);
  }

  .controls{
    display:flex;
    align-items:center;
    gap: 10px;
    margin-top: 2px;
  }

  .circleBtn{
    width: 44px; height: 44px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.10);
    display:grid; place-items:center;
    cursor:pointer;
    user-select:none;
  }
  .circleBtn.big{
    width: 54px; height: 54px;
    background: linear-gradient(135deg, var(--ap-accent), var(--ap-accent2));
    border: none;
    box-shadow: 0 12px 30px rgba(179,59,255,.25);
  }
  .circleBtn:hover{ filter: brightness(1.05); }

  .vol{
    margin-left:auto;
    display:flex;
    align-items:center;
    gap: 10px;
    min-width: 170px;
  }
  .vol span{ font-size:12px; color: var(--ap-muted); }
  .vol input{ width: 120px; }

  .listWrap{
    position:absolute;
    right: 14px;
    top: 66px;
    width: min(440px, calc(100% - 28px));
    max-height: calc(100% - 86px);
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(10,10,18,.82);
    backdrop-filter: blur(10px);
    box-shadow: 0 20px 60px rgba(0,0,0,.45);
    overflow:hidden;
    display:none;
  }
  .listWrap.open{ display:block; }

  .listHeader{
    padding: 10px 12px;
    display:flex;
    align-items:center;
    gap: 10px;
    border-bottom: 1px solid rgba(255,255,255,.12);
  }
  .listHeader b{ font-size:12px; letter-spacing:.3px; text-transform:uppercase; }
  .status{ margin-left:auto; font-size:12px; color: var(--ap-muted); }

  .list{
    max-height: 320px;
    overflow:auto;
  }
  .item{
    padding: 10px 12px;
    display:flex;
    gap: 10px;
    align-items:center;
    cursor:pointer;
    border-bottom: 1px solid rgba(255,255,255,.08);
  }
  .item:hover{ background: rgba(255,255,255,.06); }
  .item.active{ background: rgba(179,59,255,.14); }
  .num{ width: 26px; color: var(--ap-muted); font-variant-numeric: tabular-nums; }
  .name{ flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .dur{ color: var(--ap-muted); font-size:12px; }

  /* мобильная адаптация */
  @media (max-width: 520px){
    .inner{ grid-template-columns: 150px 1fr; }
    .cover{ width:110px; height:110px; }
    .vol{ display:none; }
  }
</style>

<div class="wrap">
  <div class="inner">
    <div class="left">
      <div class="cover"><img id="apCover" alt=""></div>
      <div class="viz" id="viz">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
        <div class="bar"></div><div class="bar"></div><div class="bar"></div>
      </div>
    </div>

    <div class="right">
      <div class="topRow">
        <div class="meta">
          <div class="title" id="title">—</div>
          <div class="subtitle" id="subtitle">—</div>
        </div>
        <div class="icons">
          <div class="iconBtn" id="btnShuffle" title="Shuffle">⤮</div>
          <div class="iconBtn" id="btnList" title="Playlist">≡</div>
        </div>
      </div>

      <div class="progressRow">
        <div class="time" id="tCur">0:00</div>
        <input id="range" type="range" min="0" max="1000" value="0" />
        <div class="time" id="tDur">0:00</div>
      </div>

      <div class="controls">
        <div class="circleBtn" id="btnPrev" title="Prev">⏮</div>
        <div class="circleBtn big" id="btnPlay" title="Play">▶</div>
        <div class="circleBtn" id="btnNext" title="Next">⏭</div>

        <div class="vol" id="volBox">
          <span id="volLabel">Vol</span>
          <input id="vol" type="range" min="0" max="100" value="80" />
        </div>
      </div>

      <div class="hint" id="hint" style="font-size:12px;color:var(--ap-muted);"></div>
    </div>
  </div>

  <div class="listWrap" id="listWrap">
    <div class="listHeader">
      <b id="listTitle">Playlist</b>
      <div class="status" id="status"></div>
    </div>
    <div class="list" id="list"></div>
  </div>
</div>
        `;
      }

      _wire(){
        const $ = (id)=>this.shadowRoot.getElementById(id);

        this.$title = $('title');
        this.$subtitle = $('subtitle');
        this.$cover = $('apCover');
        this.$range = $('range');
        this.$tCur = $('tCur');
        this.$tDur = $('tDur');
        this.$btnPlay = $('btnPlay');
        this.$btnPrev = $('btnPrev');
        this.$btnNext = $('btnNext');
        this.$btnShuffle = $('btnShuffle');
        this.$btnList = $('btnList');
        this.$listWrap = $('listWrap');
        this.$list = $('list');
        this.$status = $('status');
        this.$listTitle = $('listTitle');
        this.$hint = $('hint');
        this.$volBox = $('volBox');
        this.$vol = $('vol');
        this.$volLabel = $('volLabel');
        this.$viz = $('viz');

        this.$btnPlay.addEventListener('click', ()=> this.toggle());
        this.$btnPrev.addEventListener('click', ()=> this.prev());
        this.$btnNext.addEventListener('click', ()=> this.next(false));
        this.$btnShuffle.addEventListener('click', ()=> this.toggleShuffle());
        this.$btnList.addEventListener('click', ()=> this.toggleList());

        this.$range.addEventListener('input', ()=>{
          const dur = this.audio.duration || 0;
          if (!dur) return;
          const t = (parseInt(this.$range.value,10)/1000) * dur;
          this.audio.currentTime = t;
          this._renderProgress();
        });

        this.$vol.addEventListener('input', ()=>{
          this.audio.volume = parseInt(this.$vol.value,10)/100;
        });

        // initial volume
        this.audio.volume = parseInt(this.$vol.value,10)/100;
      }

      _renderText(){
        this.$btnShuffle.title = this._t('shuffle');
        this.$btnPrev.title = this._t('prev');
        this.$btnNext.title = this._t('next');
        this.$btnPlay.title = this.state.playing ? this._t('pause') : this._t('play');
        this.$listTitle.textContent = this._t('playlist');
        this.$btnList.title = this._t('playlist');
        this.$volLabel.textContent = this._t('volume');

        // show/hide volume
        const showVol = !!this._cfg?.showVolume;
        this.$volBox.style.display = showVol ? 'flex' : 'none';
      }

      _setCover(url){
        if (!url){
          // нейтральная заглушка
          this.$cover.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
            `<svg xmlns='http://www.w3.org/2000/svg' width='300' height='300'>
              <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
                <stop stop-color='#b33bff'/><stop offset='1' stop-color='#7a2bff'/>
              </linearGradient></defs>
              <rect width='100%' height='100%' fill='url(#g)'/>
              <circle cx='150' cy='150' r='92' fill='rgba(255,255,255,.18)'/>
              <text x='50%' y='54%' text-anchor='middle' font-family='Arial' font-size='44' fill='white'>♪</text>
            </svg>`
          );
          return;
        }
        this.$cover.src = url;
      }

      async _loadFromGithub(folderUrl){
        this.state.loading = true;
        this.state.error = "";
        this._renderStatus(this._t('loading'));
        this._renderList();

        try{
          const api = this._githubFolderToApi(folderUrl);
          if (!api) throw new Error('bad link');
          const files = await this._fetchGithubFiles(api);
          const tracks = files
            .filter(f => f.type === 'file' && AUDIO_EXT.test(f.name) && f.download_url)
            .map(f => ({
              name: decodeURIComponent(f.name),
              url: f.download_url
            }));

          this.state.tracks = tracks;
          this.state.idx = 0;
          this._rebuildOrder();

          if (!tracks.length){
            this._renderStatus(this._t('empty'));
            this._setNowPlayingText(null);
          }else{
            this._renderStatus(`${tracks.length}`);
            await this._loadTrack(0, false);
          }

          this._renderList();
        }catch(e){
          this.state.error = this._t('error');
          this._renderStatus(this.state.error);
          this._setNowPlayingText(null);
        }finally{
          this.state.loading = false;
        }
      }

      _githubFolderToApi(url){
        // Accept:
        // https://github.com/{owner}/{repo}/tree/{branch}/{path...}
        // also allow without /tree... -> treat as repo root
        try{
          const u = new URL(url);
          if (u.hostname !== 'github.com') return null;
          const parts = u.pathname.split('/').filter(Boolean);
          const owner = parts[0];
          const repo = parts[1];
          if (!owner || !repo) return null;

          let branch = 'main';
          let path = '';

          const treeIdx = parts.indexOf('tree');
          if (treeIdx !== -1){
            branch = parts[treeIdx+1] || 'main';
            path = parts.slice(treeIdx+2).join('/');
          }

          // GitHub Contents API
          const api = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${encodeURIComponent(branch)}`;
          return api;
        }catch{
          return null;
        }
      }

      async _fetchGithubFiles(apiUrl){
        const res = await fetch(apiUrl, {
          headers: { 'Accept':'application/vnd.github+json' }
        });
        if (!res.ok) throw new Error('fetch failed');
        const data = await res.json();
        if (Array.isArray(data)) return data;
        // if single file returned -> make array
        return [data];
      }

      _rebuildOrder(){
        const n = this.state.tracks.length;
        this.state.order = Array.from({length:n}, (_,i)=>i);
        if (this.state.shuffle){
          for (let i=n-1;i>0;i--){
            const j = Math.floor(Math.random()*(i+1));
            [this.state.order[i], this.state.order[j]] = [this.state.order[j], this.state.order[i]];
          }
        }
      }

      _currentIndexInOrder(){
        const realIdx = this.state.idx;
        const pos = this.state.order.indexOf(realIdx);
        return pos === -1 ? 0 : pos;
      }

      _resolveNextIndex(forced){
        const n = this.state.tracks.length;
        if (!n) return 0;
        const pos = this._currentIndexInOrder();
        const nextPos = (pos + 1) % n;
        return this.state.order[nextPos];
      }

      _resolvePrevIndex(){
        const n = this.state.tracks.length;
        if (!n) return 0;
        const pos = this._currentIndexInOrder();
        const prevPos = (pos - 1 + n) % n;
        return this.state.order[prevPos];
      }

      async _loadTrack(idx, autoplay){
        const t = this.state.tracks[idx];
        if (!t) return;

        this.state.idx = idx;
        this.audio.src = t.url;

        // update UI immediately
        this._setNowPlayingText(t.name);

        // wait metadata for duration display (best effort)
        await new Promise((resolve)=>{
          const onMeta = ()=>{
            this.audio.removeEventListener('loadedmetadata', onMeta);
            resolve();
          };
          this.audio.addEventListener('loadedmetadata', onMeta);
          // fallback
          setTimeout(resolve, 900);
        });

        this._renderProgress();
        this._renderList();

        if (autoplay){
          await this.play();
        }else{
          // keep paused state visually
          this._setPlaying(false);
        }
      }

      _setNowPlayingText(name){
        if (!name){
          this.$title.textContent = "—";
          this.$subtitle.textContent = "—";
          this.$hint.textContent = "";
          return;
        }
        this.$title.textContent = this._prettyTitle(name);
        this.$subtitle.textContent = this._prettySubtitle(name);
        this.$hint.textContent = "";
      }

      _prettyTitle(filename){
        // Drake - In my feelings.mp3 -> "Drake"
        const base = filename.replace(AUDIO_EXT,'');
        const parts = base.split(' - ');
        return parts[0] ? parts[0].trim() : base.trim();
      }
      _prettySubtitle(filename){
        const base = filename.replace(AUDIO_EXT,'');
        const parts = base.split(' - ');
        if (parts.length >= 2) return parts.slice(1).join(' - ').trim();
        return base.trim();
      }

      _renderStatus(text){
        this.$status.textContent = text || "";
      }

      _renderList(){
        const tracks = this.state.tracks || [];
        this.$list.innerHTML = tracks.map((t,i)=>{
          const active = i === this.state.idx ? 'active' : '';
          return `
            <div class="item ${active}" data-i="${i}">
              <div class="num">${String(i+1).padStart(2,'0')}</div>
              <div class="name">${escapeHtml(t.name)}</div>
              <div class="dur"></div>
            </div>
          `;
        }).join('');

        Array.from(this.$list.querySelectorAll('.item')).forEach(el=>{
          el.addEventListener('click', async ()=>{
            const i = parseInt(el.getAttribute('data-i'),10);
            await this._loadTrack(i, true);
          });
        });
      }

      _renderProgress(){
        const cur = this.audio.currentTime || 0;
        const dur = this.audio.duration || 0;
        this.$tCur.textContent = fmtTime(cur);
        this.$tDur.textContent = dur ? fmtTime(dur) : "0:00";
        if (dur){
          this.$range.value = String(Math.round((cur/dur)*1000));
        }else{
          this.$range.value = "0";
        }
      }

      _setPlaying(on){
        this.state.playing = on;
        this.$btnPlay.textContent = on ? "⏸" : "▶";
        this.$btnPlay.title = on ? this._t('pause') : this._t('play');
        this.shadowRoot.querySelector('.wrap')?.classList.toggle('playing', !!on);
      }

      async play(){
        if (!this.state.tracks.length) return;
        try{
          await this.audio.play();
          this._setPlaying(true);
        }catch(e){
          this._setPlaying(false);
          this.$hint.textContent = "Autoplay blocked. Click Play.";
        }
      }

      pause(){
        this.audio.pause();
        this._setPlaying(false);
      }

      toggle(){
        if (this.audio.paused) this.play();
        else this.pause();
      }

      async next(fromEnded){
        if (!this.state.tracks.length) return;
        const nextIdx = this._resolveNextIndex(fromEnded);
        await this._loadTrack(nextIdx, this.state.playing || fromEnded);
      }

      async prev(){
        if (!this.state.tracks.length) return;
        // если больше 3 сек — просто в начало трека
        if ((this.audio.currentTime||0) > 3){
          this.audio.currentTime = 0;
          return;
        }
        const prevIdx = this._resolvePrevIndex();
        await this._loadTrack(prevIdx, this.state.playing);
      }

      toggleShuffle(){
        this.state.shuffle = !this.state.shuffle;
        this._rebuildOrder();
        this.$btnShuffle.classList.toggle('active', this.state.shuffle);
      }

      toggleList(){
        this.state.showList = !this.state.showList;
        this.$listWrap.classList.toggle('open', this.state.showList);
      }
    }

    function fmtTime(s){
      s = Math.max(0, Math.floor(s||0));
      const m = Math.floor(s/60);
      const ss = String(s%60).padStart(2,'0');
      return `${m}:${ss}`;
    }
    function escapeHtml(str){
      return String(str||'')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }

    if (!customElements.get('am-audioplayer')){
      customElements.define('am-audioplayer', AMAudioPlayer);
    }
  }.toString();
}

function ensurePlayerDefined(){
  if (customElements.get('am-audioplayer')) return;
  // define from same source as generator uses
  const src = `(${playerComponentSource()})();`;
  new Function(src)();
}

renderPreview();
</script>
</body>
</html>
